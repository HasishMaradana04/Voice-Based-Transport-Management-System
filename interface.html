{% extends "base.html" %}
{% block title %}Voice Assistant - Voice Transport Management{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-microphone"></i> Voice Assistant</h5>
            </div>
            <div class="card-body text-center">
                <div class="mb-4">
                    <button id="voiceButton" class="voice-button btn">
                        <i class="fas fa-microphone"></i> Click to Speak
                    </button>
                </div>
                <div id="statusMessage" class="alert alert-info" style="display: none;"></div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header"><h6>Your Command</h6></div>
                            <div class="card-body">
                                <p id="recognizedText" class="text-muted">Click the microphone to start...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header"><h6>Assistant Response</h6></div>
                            <div class="card-body">
                                <p id="responseText" class="text-muted">Response will appear here...</p>
                                <button id="speakButton" class="btn btn-outline-primary btn-sm" style="display: none;">
                                    <i class="fas fa-volume-up"></i> Speak Response
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header"><h6>Voice Commands Help</h6></div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Sample Commands:</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-route"></i> "Route from Mumbai to Delhi"</li>
                        <li><i class="fas fa-clock"></i> "Show schedule"</li>
                        <li><i class="fas fa-ticket-alt"></i> "Book ticket from Pune to Bangalore"</li>
                        <li><i class="fas fa-question-circle"></i> "Help"</li>
                    </ul>
                </div>
                <div class="alert alert-warning">
                    <small><i class="fas fa-info-circle"></i> Speak clearly and wait for the microphone to activate.</small>
                </div>
            </div>
        </div>
        <div class="card mt-3">
            <div class="card-header"><h6>Recent Commands</h6></div>
            <div class="card-body command-history" id="commandHistory">
                <p class="text-muted">No recent commands</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
let isListening = false;
let commandHistory = [];
document.getElementById('voiceButton').addEventListener('click', function() {
    if (!isListening) {
        startListening();
    }
});
document.getElementById('speakButton').addEventListener('click', function() {
    const responseText = document.getElementById('responseText').textContent;
    if (responseText && responseText !== 'Response will appear here...') {
        speakResponse(responseText);
    }
});
function startListening() {
    const button = document.getElementById('voiceButton');
    const statusMessage = document.getElementById('statusMessage');
    isListening = true;
    button.classList.add('listening');
    button.innerHTML = '<i class="fas fa-stop"></i> Listening...';
    button.disabled = true;
    statusMessage.style.display = 'block';
    statusMessage.textContent = 'Listening for your command...';
    statusMessage.className = 'alert alert-info';
    fetch('/voice/listen', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('recognizedText').textContent = data.command;
            document.getElementById('responseText').textContent = data.response;
            document.getElementById('speakButton').style.display = 'inline-block';
            addToHistory(data.command, data.response);
            statusMessage.textContent = `Command processed in ${data.processing_time.toFixed(2)} seconds`;
            statusMessage.className = 'alert alert-success';
            setTimeout(() => speakResponse(data.response), 500);
        } else {
            statusMessage.textContent = `Error: ${data.error}`;
            statusMessage.className = 'alert alert-danger';
        }
    })
    .catch(error => {
        statusMessage.textContent = `Network error: ${error.message}`;
        statusMessage.className = 'alert alert-danger';
    })
    .finally(() => {
        isListening = false;
        button.classList.remove('listening');
        button.innerHTML = '<i class="fas fa-microphone"></i> Click to Speak';
        button.disabled = false;
    });
}
function speakResponse(text) {
    fetch('/voice/speak', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ text: text })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Speaking response...');
        }
    });
}
function addToHistory(command, response) {
    const historyDiv = document.getElementById('commandHistory');
    const timestamp = new Date().toLocaleTimeString();
    const historyItem = document.createElement('div');
    historyItem.className = 'mb-2 p-2 border-start border-primary';
    historyItem.innerHTML = `
        <small class="text-muted">${timestamp}</small><br>
        <strong>You:</strong> ${command}<br>
        <strong>Assistant:</strong> ${response.substring(0, 50)}...
    `;
    if (historyDiv.children.length === 1 && historyDiv.children[0].textContent === 'No recent commands') {
        historyDiv.innerHTML = '';
    }
    historyDiv.insertBefore(historyItem, historyDiv.firstChild);
    if (historyDiv.children.length > 5) {
        historyDiv.removeChild(historyDiv.lastChild);
    }
}
</script>
{% endblock %}
